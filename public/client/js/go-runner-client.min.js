/*
* goRunner v.0.0.1
* (c) 2014, Obogo
* License: Obogo 2014. All Rights Reserved.
*/
!function(a){function b(a,b,c){function d(a,b){var c,d;d=h[a],d&&(b?(c=d.indexOf(b),-1!==c&&d.splice(c,1)):d.length=0)}function e(a,b){return h[a]=h[a]||[],h[a].push(b),function(){d(a,b)}}function f(b,c){return b&&b.apply(a,c)}function g(a){if(h[a])for(var b=0,c=h[a],d=c.length;d>b;)f(c[b],arguments),b+=1}var h={};b&&c?(a.on=b[c.on]&&b[c.on].bind(b),a.off=b[c.off]&&b[c.off].bind(b),a.dispatch=b[c.dispatch].bind(b)):(a.on=e,a.off=d,a.dispatch=g)}function c(a){var b=[],c=0,d=a.length;if(void 0!==a.length)for(;d>c;)b.push(a[c]),c+=1;else for(c in a)a.hasOwnProperty(c)&&b.push(a[c]);return b}function d(a,b){var c,d,e,f,g;for(b||(b=function(a,b){return a>b?1:b>a?-1:0}),d=a.length,f=d-1,c=0;d>c;c+=1)for(e=0;f>e;e+=1)b(a[e],a[e+1])>0&&(g=a[e+1],a[e+1]=a[e],a[e]=g);return a}function e(b,c){var d,e,f,g=0;if(arguments.length>2&&(f=a.util.array.toArray(arguments),f.splice(0,2)),b&&b.length)for(d=b.length;d>g;){if(e=c.apply(null,[b[g],g,b].concat(f)),void 0!==e)return e;g+=1}else if(!(b instanceof Array))for(g in b)if(b.hasOwnProperty(g)&&(e=c.apply(null,[b[g],g,b].concat(f)),void 0!==e))return e;return b}function f(b,c,d,e){console.log("	step %s",b.label),e=e||"";var g,h,i,j=(e?e+".":"")+(void 0!==c?c:"R"),k={};if(k.uid=j,k.index=c,i=b.children,a.extend(k,r[n.STEP],r[b.type]||{},b),d&&(d[c]=k),i&&i.length)for(g=0,h=k.children.length,k.children=[];h>g;)f(i[g],g,k.children,j),g+=1;else k.children=[];return d?void 0:k}function g(a,b){return h(a,null,null,null,b?t:s)}function h(b,c,d,e,f){for(var g,i,j={},k=0,l=b.children.length;l>k;){g=r[b.type];for(i in b)f[i]||("children"===i?(j[i]={length:b.children.length},a.each(b.children,h,j[i],f)):b.hasOwnProperty(i)&&g[i]!==b[i]&&(j[i]=b[i]));k+=1}return e?void(e[c]=j):j}function i(a){this.dispatcher=a}function j(){function b(a){F=G=a}function c(b){var c=G;a.each(b,function(a){m.log(c,"%s.childIndex = %s",c.label,a),a=parseInt(a,10),c.childIndex=a,c=c[J][a],I.push(a),F=c,F.state=p.ENTERING}),m.log(c,"values %s",I.join("."))}function d(a){return a?I.slice(0,a):I}function e(){return F}function f(){return I.length}function g(){return F||(i(G),m.log("	%cRoot Start: %s","color:#F90",F.label)),j()||l()||k()?void(F.status===o.SKIP&&g()):F===G?void m.log(F,"%cROOT: %s","color:#F90",F.label):void g()}function h(a){var b=a.uid.split("."),c=0,d=b.length-1;for(b.shift();d>c;)b[c]=parseInt(b[c],10),c+=1;return b}function i(a){var b,c=h(a),d=0,e=c.length;for(b=q(c,0,G,-1),b&&(b.childIndex=c[e-1]),I.length=0;e>d;)I[d]=c[d],d+=1;F=a,F.state=p.ENTERING}function j(){var a=F.children.length;return F.status===o.SKIP||F.childIndex>=a?!1:a&&F.childIndex+1<a?(i(F.children[F.childIndex+1]),m.log(F,"%cgetNextChild: %s","color:#F90",F.label),!0):(F.childrenComplete=!0,!1)}function k(){var a=q(I,0,G,-1);return a?(i(a),m.log(F,"%cgetParent: %s","color:#F90",F.label),!0):!1}function l(){var a,b=I.length-1;return I[b]+=1,a=q(I,0,G,0),a?(i(a),m.log(F,"%cgetNextSibling: %s","color:#F90",F.label),!0):k()}function q(a,b,c,d){c=c||G,b=b||0,d=d||0;var e=a[b];return b>=a.length+d?c:void 0!==e&&c.children[e]?(c=c.children[e],q(a,b+1,c,d)):null}function r(a){var b=h(a);return b.length?q(b,0,G,-1):G}function s(){var a=[];return t(G,null,null,a),a}function t(b,c,d,e){b.status===o.SKIP&&a.each(b.children,B),a.each(b.children,t,e),x(b,e)}function u(a){return a.status===o.PASS?1:a.time>a.maxTime?1:a.time/a.maxTime}function v(a,b){b=b||H&&H.slice()||[],a=a||e(),H&&(H=null),x(a,b);var c=r(a);return c&&c!==a&&v(c,b),b}function w(a){H=v(a)}function x(a,b){var c,d,e=0;if(a.status===o.SKIP)return void(a.progress=0);if(a.state===p.COMPLETE)a.progress=1;else if(c=a.children.length,c&&-1!==a.childIndex){for(d=0,a.skipCount=0;e<=a.childIndex&&c>e;)a.children[e].status!=o.SKIP?d+=a.children[e].progress:a.skipCount+=1,e+=1;d+=u(a),a.progress=d/(c-a.skipCount+(a.type!==n.ROOT?1:0))}else a.progress=u(a);b.push(a)}function y(){if(F.type===n.IF||F.type===n.ELSEIF||F.type===n.ELSE){var a=q(I,0,G,-1);(F.type===n.ELSEIF||F.type===n.ELSE)&&z(a),(F.type===n.IF||F.type===n.ELSEIF)&&A(a)}}function z(a){for(var b=a.childIndex-1,c=0;b>=c;){var d=a.children[b];if(d.type!==n.IF&&d.type!==n.ELSEIF)break;B(d),b-=1}}function A(a){for(var b=a.childIndex+1,c=a.children.length;c>b;){var d=a.children[b];if(d.type!==n.ELSEIF&&d.type!==n.ELSE)break;B(d),b+=1}}function B(a){a.status!==o.SKIP&&(m.log(a,"%cSKIP %s","color:#FF6600",a.uid),a.status=o.SKIP,w(a))}function C(a){return a.type===n.IF||a.type===n.ELSEIF||a.type===n.ELSE}function D(){var a=E(G),b=a.complete?a.time/a.complete:0,c=a.total*b;return a.totalTime>c&&(c=a.totalTime),Math.ceil(.001*(c-a.time))}function E(a){for(var b,c=0,d=0,e=0,f=0,g=0,h=a.children.length;h>g;)a.children.length&&(b=E(a.children[g]),c+=b.complete,d+=b.total,e+=b.time,f+=b.totalTime),c+=a.state===p.COMPLETE?1:0,d+=1,e+=a.time,f+=a.time||2*a.increment,g+=1;return{complete:c,total:d,time:e,totalTime:f}}var F,G,H,I=[],J="children";this.setData=b,this.setPath=c,this.getDepth=f,this.next=g,this.getSelected=e,this.getPath=d,this.getProgressChanges=v,this.getAllProgress=s,this.skipBlock=y,this.isCondition=C,this.getTime=D}function k(c){function d(){return I.children}function e(a){C=a,h()}function h(){r(),k(C),I.timeLeft=G.getTime(),c.dispatch(q.RESET,I)}function k(b){var c=a.each(b.slice(),f,E);I.children=c,m.log(I,""),G.setData(I)}function l(a){H.async||(B=1),G.setPath(a?"string"==typeof a?a.split("."):a:[0]),m.log(G.getSelected(),"start %s",G.getSelected().label),c.dispatch(q.START,G.getSelected()),c.dispatch(q.STEP_START,G.getSelected(),G.getPath()),t()}function r(){clearTimeout(B),B=0,c.dispatch(q.STOP)}function s(){activeStep?(activeStep.time=0,u()):l()}function t(){H.async?(clearTimeout(B),B=setTimeout(u,G.getSelected().increment)):u()}function u(){var a=G.getSelected();m.log(a,"run %s state:%s",a.label,a.state),y(),G.isCondition(a)?a.status===o.SKIP?(a.progress=0,v()):a.state===p.COMPLETE?v():a.status!==o.PASS?w(a):a.children.length&&a.childIndex<a.children.length-1?v():a.time<a.maxTime?(a.state=p.COMPLETE,x(a)):z(a):a.children.length&&-1===a.childIndex?G.next():a.state===p.COMPLETE?x(a):a.time<a.maxTime?w(a):z(a),B&&t()}function v(){G.next(),c.dispatch(q.STEP_START,G.getSelected(),G.getPath())}function w(a){if(a.state=p.RUNNING,m.log(a,"run method %s",a.type),a.status=F[a.type](a),A(a),c.dispatch(q.STEP_UPDATE,G.getSelected(),G.getPath()),a.status===o.PASS){if(a.state=p.COMPLETE,G.skipBlock(),m.log(a,"pass %s",a.label),a.type===n.ROOT)return y(),void c.stop()}else a.time>a.maxTime&&z(a)}function x(a){return a.endTime=Date.now(),A(a),m.log(a,"complete %s",a.label),a.type===n.ROOT?void c.stop():(c.dispatch(q.STEP_END,a,G.getPath()),void v())}function y(){var b,d=G.getProgressChanges(),e=[];a.each(d,function(a){var b={uid:a.uid,progress:a.progress};a.type===n.ROOT&&(b.timeLeft=a.timeLeft=G.getTime()),e.push(b)}),c.dispatch(q.PROGRESS,d),b=g(I);var f=a.data.diff(D,b);console.log("DIFF: %o",f),D=b}function z(a){m.log(G.getSelected(),"run expired"),A(a),m.log(G.getSelected(),"expired %s %s/%s",a.label,a.time,a.maxTime),a.status=G.isCondition(a)?o.SKIP:o.TIMED_OUT,a.state=p.COMPLETE}function A(a){a.startTime||(a.startTime=Date.now()),a.time=Date.now()-a.startTime,m.log(G.getSelected(),"updateTime %s %s/%s",a.label,a.time,a.maxTime)}b(c);var B,C,D,E="R",F=new i(c),G=new j,H={async:!0},I=f({uid:E,label:n.ROOT,type:n.ROOT,children:[],index:-1,maxTime:100});return c.types=n,c.start=l,c.stop=r,c.resume=s,c.reset=h,c.getSteps=d,c.setSteps=e,c}var l=a.runner=a.runner||{};l.events={START:"runner:start",RESET:"runner:reset",PROGRESS:"runner:progress",STEP_START:"runner:stepStart",STEP_UPDATE:"runner:stepUpdate",STEP_END:"runner:stepEnd",STEP_PAUSE:"runner:stepPause",DONE:"runner:done",START_RECORDING:"runner:startRecording",STOP_RECORDING:"runner:stopRecording"},a.util=a.util||{},a.util.array=a.util.array||{},a.util.array.toArray=c,a.util.array.sort=d,a.each=e,a.extend=function(b){for(var c,d,e=a.util.array.toArray(arguments),f=1,g=e.length;g>f;){c=e[f];for(d in c)b[d]=b[d]&&"object"==typeof b[d]?a.extend(b[d],c[d]):c[d];f+=1}return b};var m=function(){function b(b){var d=b.uid.split(".").length,e=a.util.array.toArray(arguments),f=c("	",d)+b.uid+":"+b.type+":"+b.status+":"+b.state+":"+b.progress+"::";e.shift(),e[0]=f+e[0],console.log.apply(console,e)}function c(a,b){for(var c="";c.length<b;)c+=a;return c}var d={};return d.log=b,d}(),n={ROOT:"root",STEP:"step",FIND:"find",IF:"if",ELSEIF:"elseif",ELSE:"else",AJAX:"ajax",PATH:"path",PAGE:"page",SOCKET:"socket"},o={UNRESOLVED:"unresolved",FAIL:"fail",PASS:"pass",TIMED_OUT:"timedOut",SKIP:"skip"},p={WAITING:"waiting",ENTERING:"entering",RUNNING:"running",COMPLETE:"complete"},q=l.events,r={root:{},step:{label:"",type:"step",status:o.UNRESOLVED,state:p.WAITING,childIndex:-1,skipCount:0,startTime:0,endTime:0,time:0,increment:50,expectedTime:100,maxTime:2e3,progress:0},find:{maxTime:1e4},"if":{increment:10,expectedTime:50,maxTime:500},elseif:{increment:10,expectedTime:50,maxTime:500},"else":{increment:10,expectedTime:50,maxTime:500},ajax:{expectedTime:600,maxTime:6e4},path:{expectedTime:1e3,maxTime:1e4},page:{expectedTime:2e3,maxTime:3e4},socked:{expectedTime:1e3,maxTime:1e4}},s={$$hashKey:!0},t={$$hashKey:!0,uid:!0,index:!0,state:!0,status:!0,progress:!0,time:!0,startTime:!0,endTime:!0};i.prototype[n.STEP]=function(){return o.PASS},i.prototype[n.ROOT]=i.prototype[n.STEP],i.prototype[n.FIND]=function(){return o.PASS},i.prototype[n.IF]=function(a){return a.override||o.PASS},i.prototype[n.ELSEIF]=function(a){return a.override||o.PASS},i.prototype[n.ELSE]=function(a){return a.override||o.PASS};k(l)}(this.go=this.go||{},function(){return this}());
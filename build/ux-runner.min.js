/*
* uxRunner v.0.0.0
* (c) 2014, WebUX
* License: MIT.
*/
!function(a){function b(a,b,c){function d(a,b){var c,d;d=h[a],d&&(b?(c=d.indexOf(b),-1!==c&&d.splice(c,1)):d.length=0)}function e(a,b){return h[a]=h[a]||[],h[a].push(b),function(){d(a,b)}}function f(b,c){return b&&b.apply(a,c)}function g(a){if(h[a])for(var b=0,c=h[a],d=c.length;d>b;)f(c[b],arguments),b+=1}var h={};b&&c?(a.on=b[c.on]&&b[c.on].bind(b),a.off=b[c.off]&&b[c.off].bind(b),a.dispatch=b[c.dispatch].bind(b)):(a.on=e,a.off=d,a.dispatch=g)}function c(a){var b=[],c=0,d=a.length;if(void 0!==a.length)for(;d>c;)b.push(a[c]),c+=1;else for(c in a)a.hasOwnProperty(c)&&b.push(a[c]);return b}function d(a,b){var c,d,e,f,g;for(b||(b=function(a,b){return a>b?1:b>a?-1:0}),d=a.length,f=d-1,c=0;d>c;c+=1)for(e=0;f>e;e+=1)b(a[e],a[e+1])>0&&(g=a[e+1],a[e+1]=a[e],a[e]=g);return a}function e(b,c){var d,e,f,g=0;if(arguments.length>2&&(f=a.util.array.toArray(arguments),f.splice(0,2)),b&&b.length)for(d=b.length;d>g;){if(e=c.apply(null,[b[g],g,b].concat(f)),void 0!==e)return e;g+=1}else if(!(b instanceof Array))for(g in b)if(b.hasOwnProperty(g)&&(e=c.apply(null,[b[g],g,b].concat(f)),void 0!==e))return e;return b}function f(b,c,d,e){console.log("	step %s",b.label),e=e||"";var g=(e?e+".":"")+(void 0!==c?c:"R"),h={uid:g,index:c,label:"",type:"step",selector:"",check:"",pass:!1,childIndex:-1,children:[],startTime:0,time:0,increment:100,maxTime:2e3,progress:0,state:m.WAITING};return a.extend(h,b),d&&(d[c]=h),h.children.length&&a.each(h.children,f,g),d?void 0:h}function g(a){this.dispatcher=a}function h(){function b(a){q=r=a}function c(b){var c=r;a.each(b,function(a){console.log("%s.childIndex = %s",c.label,a),a=parseInt(a,10),c.childIndex=a,c=c[t][a],s.push(a),q=c,q.state=m.ENTERING}),console.log("values %s",s.join("."))}function d(a){return a?s.slice(0,a):s}function e(){return q}function f(){return s.length}function g(){return q||(q=r,q.state=m.ENTERING,console.log("	%cRoot Start: %s","color:#F90",q.label)),h()||j()||i()?void 0:q===r?void console.log("	%cROOT: %s","color:#F90",q.label):void g()}function h(){var a=q.children.length;return q.childIndex>=a?!1:a&&q.childIndex+1<a?(q.childIndex+=1,s.push(q.childIndex),q=q.children[q.childIndex],q.state=m.ENTERING,console.log("	%cgetNextChild: %s","color:#F90",q.label),!0):(q.childrenComplete=!0,!1)}function i(){var a=k(s,0,r,-1);return a?(s.pop(),q=a,q.state=m.ENTERING,console.log("	%cgetParent: %s","color:#F90",q.label),!0):!1}function j(){var a,b,c=s.length-1;return s[c]+=1,a=k(s),a?(b=k(s,0,r,-1),b.childIndex=s[c],q=a,q.state=m.ENTERING,console.log("	%cgetNextSibling: %s","color:#F90",q.label),!0):i()}function k(a,b,c,d){c=c||r,b=b||0,d=d||0;var e=a[b];return b>=a.length+d?c:void 0!==e&&c.children[e]?(c=c.children[e],k(a,b+1,c,d)):null}function l(a){var b=a.uid.split(".");return b.shift(),b.pop(),b.length?k(b):r}function n(a){return a.time>a.maxTime?1:a.time/a.maxTime}function o(a,b){b=b||[],a=a||e(),p(a,b);var c=l(a);return c&&c!==a&&o(c,b),b}function p(a,b){var c,d,e=0;if(a.state===m.COMPLETE)a.progress=1;else if(c=a.children.length,c&&-1!==a.childIndex){for(d=0;e<=a.childIndex&&c>e;)d+=a.children[e].progress,e+=1;d+=n(a),a.progress=d/(c+1)}else a.progress=n(a);b.push(a)}var q,r,s=[],t="children";this.setData=b,this.setPath=c,this.getDepth=f,this.next=g,this.getSelected=e,this.getPath=d,this.getProgressChanges=o}function i(c){function d(){return x.children}function e(b){console.log("setSteps"),a.each(b,f,"R"),x.children=b,console.log(x),v.setData(x)}function i(a){v.setPath(a?"string"==typeof a?a.split("."):a:[0]),console.log("start %s",v.getSelected().label),c.dispatch(n.START,v.getSelected()),p()}function j(){clearTimeout(t),t=0,c.dispatch(n.STOP)}function o(){activeStep?(activeStep.time=0,p()):i()}function p(){var a=v.getSelected();if(console.log("run %s state:%s",a.label,a.state),q(),a.children.length&&-1===a.childIndex)v.next();else if(a.state===m.COMPLETE){if(console.log("	complete %s",a.label),a.type===k.ROOT)return void c.stop();c.dispatch(n.STEP_END,a,v.getPath()),v.next(),c.dispatch(n.STEP_START,v.getSelected(),v.getPath())}else{if(!(a.time<a.maxTime))return void r(a);if(a.state=m.RUNNING,console.log("	run method %s",a.type),u[a.type](a),s(a),c.dispatch(n.STEP_UPDATE,v.getSelected(),v.getPath()),a.status===l.PASS&&(console.log("	pass %s",a.label),a.type===k.ROOT))return a.state=m.COMPLETE,q(),void c.stop()}w.async?(clearTimeout(t),t=setTimeout(p,a.increment)):p()}function q(){var b=v.getProgressChanges(),d=[];a.each(b,function(a){d.push({uid:a.uid,progress:a.progress})}),c.dispatch(n.PROGRESS,d)}function r(a){console.log("	run expired"),s(a),console.log("	expired %s %s/%s",a.label,a.time,a.maxTime),a.status=l.TIMED_OUT,a.state=m.COMPLETE}function s(a){a.startTime||(a.startTime=Date.now()),a.time=Date.now()-a.startTime,console.log("	updateTime %s %s/%s",a.label,a.time,a.maxTime)}b(c);var t,u=new g(c),v=new h,w={async:!0},x=f({uid:"R",label:"root",type:"root",index:-1});return c.types=k,c.start=i,c.stop=j,c.resume=o,c.getSteps=d,c.setSteps=e,c}var j=a.runner=a.runner||{};j.events={START:"runner:start",PROGRESS:"runner:progress",STEP_START:"runner:stepStart",STEP_UPDATE:"runner:stepUpdate",STEP_END:"runner:stepEnd",STEP_PAUSE:"runner:stepPause",DONE:"runner:done",START_RECORDING:"runner:startRecording",STOP_RECORDING:"runner:stopRecording"},a.util=a.util||{},a.util.array=a.util.array||{},a.util.array.toArray=c,a.util.array.sort=d,a.each=e,a.extend=function(b){for(var c,d,e=a.util.array.toArray(arguments),f=1,g=e.length;g>f;){c=e[f];for(d in c)b[d]=b[d]&&"object"==typeof b[d]?a.extend(b[d],c[d]):c[d];f+=1}return b};var k={ROOT:"root",STEP:"step",FIND:"find",CHAIN:"chain",CONDITION:"condition"},l={FAIL:"fail",PASS:"pass",TIMED_OUT:"timedOut"},m={WAITING:"waiting",ENTERING:"entering",RUNNING:"running",COMPLETE:"complete"},n=j.events;g.prototype[k.STEP]=function(a){a.status=l.PASS,a.state=m.COMPLETE},g.prototype[k.FIND]=function(a){a.status=l.PASS,a.state=m.COMPLETE},g.prototype[k.ROOT]=g.prototype[k.STEP],i(j)}(this.ux=this.ux||{},function(){return this}());
/*
* uxRunner v.0.0.0
* (c) 2014, WebUX
* License: MIT.
*/
!function(a){function b(a,b,c){function d(a,b){var c,d;d=h[a],d&&(b?(c=d.indexOf(b),-1!==c&&d.splice(c,1)):d.length=0)}function e(a,b){return h[a]=h[a]||[],h[a].push(b),function(){d(a,b)}}function f(b,c){return b&&b.apply(a,c)}function g(a){if(h[a])for(var b=0,c=h[a],d=c.length;d>b;)f(c[b],arguments),b+=1}var h={};b&&c?(a.on=b[c.on]&&b[c.on].bind(b),a.off=b[c.off]&&b[c.off].bind(b),a.dispatch=b[c.dispatch].bind(b)):(a.on=e,a.off=d,a.dispatch=g)}function c(a){var b=[],c=0,d=a.length;if(void 0!==a.length)for(;d>c;)b.push(a[c]),c+=1;else for(c in a)a.hasOwnProperty(c)&&b.push(a[c]);return b}function d(a,b){var c,d,e,f,g;for(b||(b=function(a,b){return a>b?1:b>a?-1:0}),d=a.length,f=d-1,c=0;d>c;c+=1)for(e=0;f>e;e+=1)b(a[e],a[e+1])>0&&(g=a[e+1],a[e+1]=a[e],a[e]=g);return a}function e(b,c){var d,e,f,g=0;if(arguments.length>2&&(f=a.util.array.toArray(arguments),f.splice(0,2)),b&&b.length)for(d=b.length;d>g;){if(e=c.apply(null,[b[g],g,b].concat(f)),void 0!==e)return e;g+=1}else if(!(b instanceof Array))for(g in b)if(b.hasOwnProperty(g)&&(e=c.apply(null,[b[g],g,b].concat(f)),void 0!==e))return e;return b}function f(b,c,d,e){console.log("	step %s",b.label),e=e||"";var g=(e?e+".":"")+(void 0!==c?c:"R"),h={uid:g,index:c,label:"",type:"step",status:m.UNRESOLVED,state:n.WAITING,childIndex:-1,children:[],skipCount:0,startTime:0,endTime:0,time:0,increment:50,expectedTime:100,maxTime:2e3,progress:0};return a.extend(h,b),d&&(d[c]=h),h.children.length&&a.each(h.children,f,g),d?void 0:h}function g(a){this.dispatcher=a}function h(){function b(a){F=G=a}function c(b){var c=G;a.each(b,function(a){k.log(c,"%s.childIndex = %s",c.label,a),a=parseInt(a,10),c.childIndex=a,c=c[J][a],I.push(a),F=c,F.state=n.ENTERING}),k.log(c,"values %s",I.join("."))}function d(a){return a?I.slice(0,a):I}function e(){return F}function f(){return I.length}function g(){return F||(i(G),k.log("	%cRoot Start: %s","color:#F90",F.label)),j()||p()||o()?void(F.status===m.SKIP&&g()):F===G?void k.log(F,"%cROOT: %s","color:#F90",F.label):void g()}function h(a){var b=a.uid.split("."),c=0,d=b.length-1;for(b.shift();d>c;)b[c]=parseInt(b[c],10),c+=1;return b}function i(a){var b,c=h(a),d=0,e=c.length;for(b=q(c,0,G,-1),b&&(b.childIndex=c[e-1]),I.length=0;e>d;)I[d]=c[d],d+=1;F=a,F.state=n.ENTERING}function j(){var a=F.children.length;return F.status===m.SKIP||F.childIndex>=a?!1:a&&F.childIndex+1<a?(i(F.children[F.childIndex+1]),k.log(F,"%cgetNextChild: %s","color:#F90",F.label),!0):(F.childrenComplete=!0,!1)}function o(){var a=q(I,0,G,-1);return a?(i(a),k.log(F,"%cgetParent: %s","color:#F90",F.label),!0):!1}function p(){var a,b=I.length-1;return I[b]+=1,a=q(I,0,G,0),a?(i(a),k.log(F,"%cgetNextSibling: %s","color:#F90",F.label),!0):o()}function q(a,b,c,d){c=c||G,b=b||0,d=d||0;var e=a[b];return b>=a.length+d?c:void 0!==e&&c.children[e]?(c=c.children[e],q(a,b+1,c,d)):null}function r(a){var b=h(a);return b.length?q(b,0,G,-1):G}function s(){var a=[];return t(G,null,null,a),a}function t(b,c,d,e){b.status===m.SKIP&&a.each(b.children,B),a.each(b.children,t,e),x(b,e)}function u(a){return a.status===m.PASS?1:a.time>a.maxTime?1:a.time/a.maxTime}function v(a,b){b=b||H&&H.slice()||[],a=a||e(),H&&(H=null),x(a,b);var c=r(a);return c&&c!==a&&v(c,b),b}function w(a){H=v(a)}function x(a,b){var c,d,e=0;if(a.status===m.SKIP)return void(a.progress=0);if(a.state===n.COMPLETE)a.progress=1;else if(c=a.children.length,c&&-1!==a.childIndex){for(d=0,a.skipCount=0;e<=a.childIndex&&c>e;)a.children[e].status!=m.SKIP?d+=a.children[e].progress:a.skipCount+=1,e+=1;d+=u(a),a.progress=d/(c-a.skipCount+(a.type!==l.ROOT?1:0))}else a.progress=u(a);b.push(a)}function y(){if(F.type===l.IF||F.type===l.ELSEIF||F.type===l.ELSE){var a=q(I,0,G,-1);(F.type===l.ELSEIF||F.type===l.ELSE)&&z(a),(F.type===l.IF||F.type===l.ELSEIF)&&A(a)}}function z(a){for(var b=a.childIndex-1,c=0;b>=c;){var d=a.children[b];if(d.type!==l.IF&&d.type!==l.ELSEIF)break;B(d),b-=1}}function A(a){for(var b=a.childIndex+1,c=a.children.length;c>b;){var d=a.children[b];if(d.type!==l.ELSEIF&&d.type!==l.ELSE)break;B(d),b+=1}}function B(a){if(a.status!==m.SKIP){k.log(a,"%cSKIP %s","color:#FF6600",a.uid);{r(a)}a.status=m.SKIP,w(a)}}function C(a){return a.type===l.IF||a.type===l.ELSEIF||a.type===l.ELSE}function D(){var a=E(G),b=a.time/a.complete,c=a.total*b;return a.totalTime>c&&(c=a.totalTime),a.estimate=Math.ceil(.001*(c-a.time)),a}function E(a){for(var b,c=0,d=0,e=0,f=0,g=0,h=a.children.length;h>g;)a.children.length&&(b=E(a.children[g]),c+=b.complete,d+=b.total,e+=b.time,f+=b.totalTime),c+=a.state===n.COMPLETE?1:0,d+=1,e+=a.time,f+=a.time||2*a.increment,g+=1;return{complete:c,total:d,time:e,totalTime:f}}var F,G,H,I=[],J="children";this.setData=b,this.setPath=c,this.getDepth=f,this.next=g,this.getSelected=e,this.getPath=d,this.getProgressChanges=v,this.getAllProgress=s,this.skipBlock=y,this.isCondition=C,this.getTime=D}function i(c){function d(){return D.children}function e(b){a.each(b,f,z),D.children=b,k.log(D,""),B.setData(D)}function i(a){C.async||(y=1),B.setPath(a?"string"==typeof a?a.split("."):a:[0]),k.log(B.getSelected(),"start %s",B.getSelected().label),c.dispatch(o.START,B.getSelected()),c.dispatch(o.STEP_START,B.getSelected(),B.getPath()),q()}function j(){clearTimeout(y),y=0,c.dispatch(o.STOP)}function p(){activeStep?(activeStep.time=0,r()):i()}function q(){C.async?(clearTimeout(y),y=setTimeout(r,B.getSelected().increment)):r()}function r(){var a=B.getSelected();k.log(a,"run %s state:%s",a.label,a.state),v(),B.isCondition(a)?a.status===m.SKIP?(a.progress=0,s()):a.state===n.COMPLETE?s():a.status!==m.PASS?t(a):a.children.length&&a.childIndex<a.children.length-1?s():a.time<a.maxTime?(a.state=n.COMPLETE,u(a)):w(a):a.children.length&&-1===a.childIndex?B.next():a.state===n.COMPLETE?u(a):a.time<a.maxTime?t(a):w(a),y&&q()}function s(){B.next(),c.dispatch(o.STEP_START,B.getSelected(),B.getPath())}function t(a){if(a.state=n.RUNNING,k.log(a,"run method %s",a.type),a.status=A[a.type](a),x(a),c.dispatch(o.STEP_UPDATE,B.getSelected(),B.getPath()),a.status===m.PASS){if(a.state=n.COMPLETE,B.skipBlock(),k.log(a,"pass %s",a.label),a.type===l.ROOT)return v(),void c.stop()}else a.time>a.maxTime&&w(a)}function u(a){return a.endTime=Date.now(),x(a),k.log(a,"complete %s",a.label),a.type===l.ROOT?void c.stop():(c.dispatch(o.STEP_END,a,B.getPath()),void s())}function v(){var b=B.getProgressChanges(),d=[];a.each(b,function(a){var b={uid:a.uid,progress:a.progress};a.type===l.ROOT&&(b.timeLeft=a.timeLeft=B.getTime()),d.push(b)}),c.dispatch(o.PROGRESS,b)}function w(a){k.log(B.getSelected(),"run expired"),x(a),k.log(B.getSelected(),"expired %s %s/%s",a.label,a.time,a.maxTime),a.status=B.isCondition(a)?m.SKIP:m.TIMED_OUT,a.state=n.COMPLETE}function x(a){a.startTime||(a.startTime=Date.now()),a.time=Date.now()-a.startTime,k.log(B.getSelected(),"updateTime %s %s/%s",a.label,a.time,a.maxTime)}b(c);var y,z="R",A=new g(c),B=new h,C={async:!0},D=f({uid:z,label:"root",type:"root",index:-1,maxTime:100});return c.types=l,c.start=i,c.stop=j,c.resume=p,c.getSteps=d,c.setSteps=e,c}var j=a.runner=a.runner||{};j.events={START:"runner:start",PROGRESS:"runner:progress",STEP_START:"runner:stepStart",STEP_UPDATE:"runner:stepUpdate",STEP_END:"runner:stepEnd",STEP_PAUSE:"runner:stepPause",DONE:"runner:done",START_RECORDING:"runner:startRecording",STOP_RECORDING:"runner:stopRecording"},a.util=a.util||{},a.util.array=a.util.array||{},a.util.array.toArray=c,a.util.array.sort=d,a.each=e,a.extend=function(b){for(var c,d,e=a.util.array.toArray(arguments),f=1,g=e.length;g>f;){c=e[f];for(d in c)b[d]=b[d]&&"object"==typeof b[d]?a.extend(b[d],c[d]):c[d];f+=1}return b};var k=function(){function b(b){var d=b.uid.split(".").length,e=a.util.array.toArray(arguments),f=c("	",d)+b.uid+":"+b.type+":"+b.status+":"+b.state+":"+b.progress+"::";e.shift(),e[0]=f+e[0],console.log.apply(console,e)}function c(a,b){for(var c="";c.length<b;)c+=a;return c}var d={};return d.log=b,d}(),l={ROOT:"root",STEP:"step",FIND:"find",CHAIN:"chain",IF:"if",ELSEIF:"elseif",ELSE:"else"},m={UNRESOLVED:"unresolved",FAIL:"fail",PASS:"pass",TIMED_OUT:"timedOut",SKIP:"skip"},n={WAITING:"waiting",ENTERING:"entering",RUNNING:"running",COMPLETE:"complete"},o=j.events;g.prototype[l.STEP]=function(){return m.PASS},g.prototype[l.ROOT]=g.prototype[l.STEP],g.prototype[l.FIND]=function(){return m.PASS},g.prototype[l.IF]=function(a){return a.time>.5*a.maxTime?a.override||m.PASS:n.FAIL},g.prototype[l.ELSEIF]=function(a){return a.override||m.PASS},g.prototype[l.ELSE]=function(a){return a.override||m.PASS};i(j)}(this.ux=this.ux||{},function(){return this}());